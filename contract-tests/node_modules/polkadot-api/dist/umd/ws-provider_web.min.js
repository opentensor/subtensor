(function(S,y){typeof exports=="object"&&typeof module<"u"?y(exports):typeof define=="function"&&define.amd?define(["exports"],y):(S=typeof globalThis<"u"?globalThis:S||self,y(S.papiWsProviderWeb={}))})(this,(function(S){"use strict";const y=n=>JSON.stringify({jsonrpc:"2.0",...n});let j=0;const M=()=>`proxyOpaque${j++}`,$=()=>`___proxyInternalId__${M()}`,J=n=>{let e={type:1,activeBroadcasts:new Map,pending:[]};const i=r=>{let c=!0;if(e.type===0){const o=JSON.parse(r);if("id"in o){const{id:t}=o;if(e.pendingBroadcasts.has(t)){const a=e.pendingBroadcasts.get(t),l=o.result;e.pendingBroadcasts.delete(t),e.activeBroadcasts.get(a)?e.activeBroadcasts.get(a).upToken=l:e.connection.send(y({id:$(),method:"transaction_v1_stop",params:[l]}));return}c=e.onGoingRequests.has(t),"result"in o&&e.onGoingRequests.get(t)?.type===0&&e.activeChainHeads.add(o.result),e.onGoingRequests.delete(o.id)}else if("params"in o){const{subscription:t,result:a}=o.params;a?.event==="stop"&&e.activeChainHeads.delete(t)}}c&&e.type!==2&&n(r)},d=r=>{if(e.type===2)return;const c=JSON.parse(r);if("id"in c){const{method:o,id:t,params:a}=c,[l,,p]=o.split("_");if(l==="transaction"){if(p==="stop"){const[s]=a,u=e.activeBroadcasts.get(s);e.activeBroadcasts.delete(s),n(y({id:t,result:null})),e.type===0&&u&&u.upToken&&e.connection.send(y({id:t,method:o,params:[u.upToken]}));return}if(p==="broadcast"){const s=M();e.activeBroadcasts.set(s,{tx:a[0],synToken:s}),e.type===0&&(e.pendingBroadcasts.set(t,s),e.connection.send(r)),n(y({id:t,result:s}));return}}}if(e.type===1){e.pending.push(r);return}if(c.method==="chainHead_v1_unfollow"&&e.activeChainHeads.delete(c.params[0]),"id"in c){const{method:o,id:t}=c,[a,,l]=o.split("_"),p=a==="chainHead"?l==="follow"?{type:0,msg:r}:{type:1,id:t}:{type:2,msg:r};e.onGoingRequests.set(t,p)}e.connection.send(r)};return{send:d,disconnect:()=>{e.type!==2&&(e.type===0&&e.connection.disconnect(),e={type:2})},connect:r=>{if(e.type!==1)throw new Error("Nonesense");const{pending:c,activeBroadcasts:o}=e,t=new Map,a=new Set;e={type:0,connection:r(i,()=>{const p=e.type!==2?e.activeBroadcasts:new Map;p.forEach(s=>s.upToken=void 0),e={type:1,activeBroadcasts:p,pending:[]},a.forEach(s=>{i(y({params:{subscription:s,result:{event:"stop",internal:!0}}}))}),a.clear();for(const s of t.values())s.type===1?i(y({id:s.id,error:{code:-32603,message:"Internal error"},internal:!0})):d(s.msg);t.clear()}),activeBroadcasts:o,pendingBroadcasts:new Map,onGoingRequests:t,activeChainHeads:a},o.forEach(p=>{if(e.type===0){const s=$();e.pendingBroadcasts.set(s,p.synToken),d(y({id:s,method:"transaction_v1_broadcast",params:[p.tx]}))}}),c.forEach(d)}}},x=n=>e=>{let i=J(e);const d=()=>{n().then(r=>{if(i)i.connect((c,o)=>r(c,()=>{o(),d()}));else try{r(()=>{},()=>{}).disconnect()}catch{}},()=>{i&&setTimeout(d,0)})};return d(),{send:r=>{i?.send(r)},disconnect:()=>{i?.disconnect(),i=null}}};var g=(n=>(n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.ERROR=2]="ERROR",n[n.CLOSE=3]="CLOSE",n))(g||{});const B={};["v1","unstable"].forEach(n=>{B[`chainHead_${n}_follow`]="follow",B[`chainHead_${n}_unfollow`]="unfollow"});const G=()=>({latest:Date.now(),count:0}),z=(n,e)=>{const i=new Set,d=new Map,r=new Set;let c,o=G();return Object.assign(a=>{const{send:l,disconnect:p}=n(s=>{const u=JSON.parse(s);if("id"in u){const{id:h,result:E}=u;if(h===c&&(c=void 0,E&&!E.methods.some(v=>{const[f,,_]=v.split("_");return f==="chainHead"&&_==="follow"}))){a(s),e();return}const m=d.get(h);if(m){if(d.delete(h),i.has(E)){i.delete(E);return}r.add(E);const v=r.size+d.size;if(v>2)console.warn(`Too many chainHead follow subscriptions (${v})`);else if(u.error){console.warn(`chainHead follow failed on the ${v} sub`),e(),d.set(h,m),l(m);return}}}else{const{subscription:h,result:E}=u.params;if(E?.event==="stop"){const m=Date.now()-o.latest;o.latest+=m,o.count=m<1e3?o.count+1:1,r.has(h)?r.delete(h):i.add(h)}}a(s),o.count>2&&(o=G(),e())});return{send(s){const u=JSON.parse(s);u.method==="rpc_methods"&&(c=u.id);const h=B[u.method];h==="follow"?d.set(u.id,s):h==="unfollow"&&r.delete(u.params[0]),l(s)},disconnect:p}},{cleanup:()=>{i.clear(),d.clear(),r.clear()}})},q={type:g.ERROR,event:{type:"timeout"}},R=()=>{},A={onStatusChanged:R,innerEnhancer:n=>n,timeout:5e3,heartbeatTimeout:4e4},H=n=>n.map(e=>typeof e=="string"?[e]:[e.uri,e.protocol]),D=(n,e)=>{const{onStatusChanged:i,innerEnhancer:d,timeout:r,heartbeatTimeout:c}={...A,...e},o=H(Array.isArray(n)?n:[n]),t=e?.websocketClass??globalThis.WebSocket;if(!t)throw new Error("Missing WebSocket class");let a=0,l,p=null,s=R,u=R;const h=z(x(async()=>{const[m,v]=p||o[a++%n.length];p=null;const f=new t(m,v),_=()=>{try{f.addEventListener("error",R,{once:!0}),f.close()}catch{}};i(l={type:g.CONNECTING,uri:m,protocols:v}),await new Promise((L,b)=>{const C=()=>{N(),L()},w=T=>{N(),T==null&&_(),console.error(`Unable to connect to ${m}${v?", protocols: "+v:""}`),i(l={type:T?g.ERROR:g.CLOSE,event:T}),setTimeout(b,T?300:0,T)},k=r!==1/0?setTimeout(()=>{N(),_(),i(l=q),b(q.event)},r):void 0,N=()=>{clearTimeout(k),f.removeEventListener("error",w),f.removeEventListener("open",C)};f.addEventListener("open",C),f.addEventListener("error",w),s=()=>{w(null)}}),i(l={type:g.CONNECTED,uri:m,protocols:v});let P;const U=d(L=>(P=L,{send:b=>{f.send(b)},disconnect:()=>{s()}}));return(L,b)=>{let C;const w=()=>{clearTimeout(C),C=setTimeout(()=>{console.warn("Terminate: heartbeat timeout"),s(!0)},c)};w();const k=U(L),N=O=>{w(),typeof O.data=="string"&&P(O.data)},T=O=>K=>{clearTimeout(C),console.warn(`WS halt (${O})`),i(l={type:O,event:K}),b()},W=T(g.ERROR),I=T(g.CLOSE);return f.addEventListener("ping",w),f.addEventListener("message",N),f.addEventListener("error",W),f.addEventListener("close",I),s=O=>{clearTimeout(C),u(),s=R,f.removeEventListener("ping",w),f.removeEventListener("message",N),f.removeEventListener("error",W),f.removeEventListener("close",I),_(),O&&I({}),k.disconnect()},k}}),()=>{E()});u=h.cleanup,delete h.cleanup;const E=(...m)=>{l.type!==g.CLOSE&&(m.length&&(p=m),l.type!==g.ERROR&&s(!0))};return Object.assign(h,{switch:E,getStatus:()=>l})},F=(n=>(...e)=>{let i=[],{heartbeatTimeout:d,timeout:r,innerEnhancer:c,onStatusChanged:o}=A;const[t]=e;return e.length===1&&typeof t=="object"&&!Array.isArray(t)?(i=H(t.endpoints),o=t.onStatusChanged??R,r=t.timeout??r,d=t.heartbeatTimeout??d,c=t.innerEnhancer??(a=>a)):(typeof e[1]=="function"&&(o=e[1]),Array.isArray(t)?i=H(t):(i=[[t]],e[1]&&e[1]!==o&&(i[0][1]=e[1]),e[2]&&(o=e[2]))),D(i.map(a=>a.length===1?a[0]:{uri:a[0],protocol:a[1]}),{websocketClass:n,onStatusChanged:o,timeout:r,innerEnhancer:c})})(WebSocket);S.WsEvent=g,S.getWsProvider=F}));
