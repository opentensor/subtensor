import { noop } from '@polkadot-api/utils';
import { StorageError } from './errors.mjs';

const createStorageCb = (archiveRequest) => (hash, inputs, childTrie, onItem, onError, onDone) => {
  if (inputs.length === 0) {
    onDone();
    return noop;
  }
  let isRunning = true;
  let cancel = () => {
    isRunning = false;
  };
  archiveRequest("storage", [hash, inputs, childTrie], {
    onSuccess: (operationId, followSubscription) => {
      const stopOperation = () => {
        archiveRequest("stopStorage", [operationId]);
      };
      if (!isRunning) return stopOperation();
      const doneListening = followSubscription(operationId, {
        next: (event) => {
          const { event: type } = event;
          if (type === "storage") {
            const { event: _, ...item } = event;
            onItem(item);
          } else if (type === "storageDone") _onDone();
          else _onError(new StorageError(event.error));
        },
        error: onError
      });
      const tearDown = () => {
        cancel = noop;
        doneListening();
      };
      cancel = () => {
        tearDown();
        stopOperation();
      };
      const _onError = (e) => {
        tearDown();
        onError(e);
      };
      const _onDone = () => {
        tearDown();
        onDone();
      };
    },
    onError
  });
  return () => {
    cancel();
  };
};

export { createStorageCb };
//# sourceMappingURL=storage-subscription.mjs.map
