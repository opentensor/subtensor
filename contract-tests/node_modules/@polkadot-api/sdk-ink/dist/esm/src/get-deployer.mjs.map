{"version":3,"file":"get-deployer.mjs","sources":["../../../src/get-deployer.ts"],"sourcesContent":["import {\n  flattenResult,\n  FlattenValues,\n  mapResult,\n  wrapAsyncTx,\n} from \"@polkadot-api/common-sdk-utils\"\nimport { Binary, Enum, FixedSizeBinary } from \"polkadot-api\"\nimport type {\n  GenericInkDescriptors,\n  InkSdkTypedApi,\n  ReviveSdkTypedApi,\n} from \"./descriptor-types\"\nimport { EncodingProvider } from \"./encoding-provider\"\nimport { ContractsProvider } from \"./provider\"\nimport type { Deployer } from \"./sdk-types\"\nimport { getSignedStorage, getStorageLimit } from \"./util\"\n\nexport function getDeployer<\n  T extends InkSdkTypedApi | ReviveSdkTypedApi,\n  Addr,\n  StorageErr,\n  D extends GenericInkDescriptors,\n  PublicAddr extends string,\n>(\n  provider: ContractsProvider<Addr, StorageErr>,\n  encodingProvider: EncodingProvider,\n  code: Enum<{\n    Upload: Binary\n    Existing: Promise<FixedSizeBinary<32>>\n  }>,\n  mapAddr: (v: Addr) => PublicAddr,\n): Deployer<T, D, PublicAddr> {\n  const loadedCode = async (): Promise<\n    Enum<{\n      Upload: Binary\n      Existing: FixedSizeBinary<32>\n    }>\n  > =>\n    code.type === \"Upload\"\n      ? code\n      : {\n          type: \"Existing\",\n          value: await code.value,\n        }\n\n  const deployer: Deployer<T, D, PublicAddr> = {\n    async dryRun(constructorLabel, args) {\n      const ctor = encodingProvider.constructor(constructorLabel)\n      const value = args.value ?? 0n\n      const data = ctor.encode(args.data ?? {})\n\n      const response = await provider.dryRunInstantiate(\n        args.origin,\n        value,\n        args.options?.gasLimit,\n        args.options?.storageDepositLimit,\n        code.type === \"Existing\" ? Enum(\"Existing\", await code.value) : code,\n        data,\n        args.options?.salt,\n      )\n      if (response.result.success) {\n        const decoded = ctor.decode(\n          response.result.value.result.data,\n        ) as FlattenValues<\n          D[\"__types\"][\"messages\"][typeof constructorLabel][\"response\"]\n        >\n        const address = response.result.value.addr\n\n        return mapResult(flattenResult(decoded), {\n          value: (value) => ({\n            address: mapAddr(address),\n            response: value,\n            events: encodingProvider.filterEvents(\n              mapAddr(address),\n              response.events,\n            ),\n            gasRequired: response.gas_required,\n            storageDeposit: getSignedStorage(response.storage_deposit),\n            deploy() {\n              const limitParams = {\n                gasLimit: response.gas_required,\n                storageDepositLimit: getStorageLimit(response.storage_deposit),\n              }\n              return deployer.deploy(constructorLabel, {\n                ...args,\n                ...limitParams,\n              })\n            },\n          }),\n        })\n      }\n      return {\n        success: false,\n        value: response.result.value,\n      }\n    },\n    deploy: (constructorLabel, args) =>\n      wrapAsyncTx(async () => {\n        const ctor = encodingProvider.constructor(constructorLabel)\n\n        const limits = await (async () => {\n          if (\"gasLimit\" in args)\n            return {\n              gas: args.gasLimit,\n              storage: args.storageDepositLimit,\n            }\n\n          const response = await provider.dryRunInstantiate(\n            args.origin,\n            args.value ?? 0n,\n            undefined,\n            undefined,\n            code.type === \"Existing\"\n              ? Enum(\"Existing\", await code.value)\n              : code,\n            ctor.encode(args.data ?? {}),\n            args.options?.salt,\n          )\n\n          return {\n            gas: response.gas_required,\n            storage: getStorageLimit(response.storage_deposit),\n          }\n        })()\n\n        const params = {\n          value: args.value ?? 0n,\n          gas_limit: limits.gas,\n          storage_deposit_limit: limits.storage,\n          data: ctor.encode(args.data ?? {}),\n          salt: args.options?.salt,\n        }\n\n        return code.type === \"Upload\"\n          ? provider.txInstantiateWithCode({\n              ...params,\n              code: code.value,\n            })\n          : provider.txInstantiate({\n              ...params,\n              code_hash: await code.value,\n            })\n      }),\n    estimateAddress: async (constructorLabel, args) => {\n      const ctor = encodingProvider.constructor(constructorLabel)\n      const data = ctor.encode(args.data ?? {})\n\n      const addr = await provider.getEstimatedAddress(\n        args.origin,\n        args.value ?? 0n,\n        await loadedCode(),\n        data,\n        args.salt,\n        args.nonce,\n      )\n      return addr ? mapAddr(addr) : null\n    },\n  }\n\n  return deployer\n}\n"],"names":["value"],"mappings":"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"}