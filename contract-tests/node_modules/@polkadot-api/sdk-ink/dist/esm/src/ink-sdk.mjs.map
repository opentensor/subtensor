{"version":3,"file":"ink-sdk.mjs","sources":["../../../src/ink-sdk.ts"],"sourcesContent":["import { Binary, Enum, HexString, PolkadotClient } from \"polkadot-api\"\nimport { wndAh } from \"../.papi/descriptors/dist\"\nimport { GenericInkDescriptors, ReviveStorageError } from \"./descriptor-types\"\nimport { EncodingProvider, inkEncoding, solEncoding } from \"./encoding-provider\"\nimport { getContract } from \"./get-contract\"\nimport { getDeployer } from \"./get-deployer\"\nimport { reviveProvider } from \"./provider\"\nimport { getAccountId } from \"./revive-sdk\"\nimport {\n  CommonTypedApi,\n  Contract,\n  defaultOptions,\n  Deployer,\n  GetContract,\n  InkSdk,\n  InkSdkOptions,\n} from \"./sdk-types\"\nimport { reviveAddressIsMapped } from \"./util\"\n\nexport const createInkSdk = (\n  client: PolkadotClient,\n  options?: Partial<InkSdkOptions>,\n): InkSdk => {\n  const typedApi: CommonTypedApi = client.getTypedApi(wndAh)\n\n  const { atBest } = { ...defaultOptions, ...options }\n  const provider = reviveProvider(typedApi, atBest)\n\n  const getContractSdk = <D extends GenericInkDescriptors>(\n    encodingProvider: EncodingProvider,\n    address: HexString,\n  ): Contract<CommonTypedApi, D, HexString, ReviveStorageError> => {\n    return getContract(\n      provider,\n      encodingProvider,\n      Binary.fromHex(address),\n      (v) => v.asHex(),\n      getAccountId(address),\n    )\n  }\n\n  const getDeployerSdk = <D extends GenericInkDescriptors>(\n    contractDescriptors: D,\n    code: Binary,\n  ): Deployer<CommonTypedApi, D, HexString> => {\n    const encodingProvider = contractDescriptors.metadata\n      ? inkEncoding(contractDescriptors)\n      : solEncoding(contractDescriptors)\n\n    return getDeployer(provider, encodingProvider, Enum(\"Upload\", code), (v) =>\n      v.asHex(),\n    )\n  }\n\n  const curriedGetContract: GetContract = ((\n    contractDescriptors,\n    address?: HexString,\n  ) => {\n    const encodingProvider = contractDescriptors.metadata\n      ? inkEncoding(contractDescriptors)\n      : solEncoding(contractDescriptors)\n\n    if (address == null) {\n      return (address: HexString) => getContractSdk(encodingProvider, address)\n    }\n    return getContractSdk(encodingProvider, address)\n  }) as GetContract\n\n  return {\n    addressIsMapped(address) {\n      return reviveAddressIsMapped(typedApi, address)\n    },\n    getContract: curriedGetContract,\n    getDeployer: getDeployerSdk,\n    readDeploymentEvents: (contractDescriptors, events) => {\n      const encodingProvider = contractDescriptors.metadata\n        ? inkEncoding(contractDescriptors)\n        : solEncoding(contractDescriptors)\n\n      const instantiatedEvents =\n        events\n          ?.filter(\n            (evt) =>\n              evt.type === \"Revive\" &&\n              (evt.value as any).type === \"Instantiated\",\n          )\n          .map(\n            (v) =>\n              (v.value as any).value as {\n                deployer: Binary\n                contract: Binary\n              },\n          ) ?? []\n\n      return instantiatedEvents.map((evt) => ({\n        address: evt.contract.asHex(),\n        contractEvents: encodingProvider.filterEvents(\n          evt.contract.asHex(),\n          events,\n        ),\n      }))\n    },\n  }\n}\n"],"names":["wndAh","address"],"mappings":";;;;;;;;;;AAmBO,MAAM,YAAA,GAAe,CAC1B,MAAA,EACA,OAAA,KACW;AACX,EAAA,MAAM,QAAA,GAA2B,MAAA,CAAO,WAAA,CAAYA,aAAK,CAAA;AAEzD,EAAA,MAAM,EAAE,MAAA,EAAO,GAAI,EAAE,GAAG,cAAA,EAAgB,GAAG,OAAA,EAAQ;AACnD,EAAA,MAAM,QAAA,GAAW,cAAA,CAAe,QAAA,EAAU,MAAM,CAAA;AAEhD,EAAA,MAAM,cAAA,GAAiB,CACrB,gBAAA,EACA,OAAA,KAC+D;AAC/D,IAAA,OAAO,WAAA;AAAA,MACL,QAAA;AAAA,MACA,gBAAA;AAAA,MACA,MAAA,CAAO,QAAQ,OAAO,CAAA;AAAA,MACtB,CAAC,CAAA,KAAM,CAAA,CAAE,KAAA,EAAM;AAAA,MACf,aAAa,OAAO;AAAA,KACtB;AAAA,EACF,CAAA;AAEA,EAAA,MAAM,cAAA,GAAiB,CACrB,mBAAA,EACA,IAAA,KAC2C;AAC3C,IAAA,MAAM,mBAAmB,mBAAA,CAAoB,QAAA,GACzC,YAAY,mBAAmB,CAAA,GAC/B,YAAY,mBAAmB,CAAA;AAEnC,IAAA,OAAO,WAAA;AAAA,MAAY,QAAA;AAAA,MAAU,gBAAA;AAAA,MAAkB,IAAA,CAAK,UAAU,IAAI,CAAA;AAAA,MAAG,CAAC,CAAA,KACpE,CAAA,CAAE,KAAA;AAAM,KACV;AAAA,EACF,CAAA;AAEA,EAAA,MAAM,kBAAA,IAAmC,CACvC,mBAAA,EACA,OAAA,KACG;AACH,IAAA,MAAM,mBAAmB,mBAAA,CAAoB,QAAA,GACzC,YAAY,mBAAmB,CAAA,GAC/B,YAAY,mBAAmB,CAAA;AAEnC,IAAA,IAAI,WAAW,IAAA,EAAM;AACnB,MAAA,OAAO,CAACC,QAAAA,KAAuB,cAAA,CAAe,gBAAA,EAAkBA,QAAO,CAAA;AAAA,IACzE;AACA,IAAA,OAAO,cAAA,CAAe,kBAAkB,OAAO,CAAA;AAAA,EACjD,CAAA,CAAA;AAEA,EAAA,OAAO;AAAA,IACL,gBAAgB,OAAA,EAAS;AACvB,MAAA,OAAO,qBAAA,CAAsB,UAAU,OAAO,CAAA;AAAA,IAChD,CAAA;AAAA,IACA,WAAA,EAAa,kBAAA;AAAA,IACb,WAAA,EAAa,cAAA;AAAA,IACb,oBAAA,EAAsB,CAAC,mBAAA,EAAqB,MAAA,KAAW;AACrD,MAAA,MAAM,mBAAmB,mBAAA,CAAoB,QAAA,GACzC,YAAY,mBAAmB,CAAA,GAC/B,YAAY,mBAAmB,CAAA;AAEnC,MAAA,MAAM,qBACJ,MAAA,EACI,MAAA;AAAA,QACA,CAAC,GAAA,KACC,GAAA,CAAI,SAAS,QAAA,IACZ,GAAA,CAAI,MAAc,IAAA,KAAS;AAAA,OAChC,CACC,GAAA;AAAA,QACC,CAAC,CAAA,KACE,CAAA,CAAE,KAAA,CAAc;AAAA,WAIhB,EAAC;AAEV,MAAA,OAAO,kBAAA,CAAmB,GAAA,CAAI,CAAC,GAAA,MAAS;AAAA,QACtC,OAAA,EAAS,GAAA,CAAI,QAAA,CAAS,KAAA,EAAM;AAAA,QAC5B,gBAAgB,gBAAA,CAAiB,YAAA;AAAA,UAC/B,GAAA,CAAI,SAAS,KAAA,EAAM;AAAA,UACnB;AAAA;AACF,OACF,CAAE,CAAA;AAAA,IACJ;AAAA,GACF;AACF;;;;"}