{"version":3,"file":"revive-sdk.mjs","sources":["../../../src/revive-sdk.ts"],"sourcesContent":["import { AccountId, Binary, Enum, HexString } from \"polkadot-api\"\nimport { mergeUint8 } from \"polkadot-api/utils\"\nimport type {\n  GenericInkDescriptors,\n  ReviveSdkTypedApi,\n  ReviveStorageError,\n} from \"./descriptor-types\"\nimport { inkEncoding, solEncoding } from \"./encoding-provider\"\nimport { getContract } from \"./get-contract\"\nimport { getDeployer } from \"./get-deployer\"\nimport { reviveProvider } from \"./provider\"\nimport { defaultOptions, type InkSdkOptions, type ReviveSdk } from \"./sdk-types\"\nimport { ss58ToEthereum } from \"./util\"\n\n/**\n * @deprecated use `createInkSdk(client)` instead\n */\nexport const createReviveSdk = <\n  T extends ReviveSdkTypedApi,\n  D extends GenericInkDescriptors,\n>(\n  typedApi: T,\n  contractDescriptors: D,\n  options?: Partial<InkSdkOptions>,\n): ReviveSdk<T, D, HexString, ReviveStorageError> => {\n  const { atBest } = { ...defaultOptions, ...options }\n  const provider = reviveProvider(typedApi, atBest)\n  const encodingProvider = contractDescriptors.metadata\n    ? inkEncoding(contractDescriptors)\n    : solEncoding(contractDescriptors)\n\n  return {\n    getContract: (address) =>\n      getContract(\n        provider,\n        encodingProvider,\n        Binary.fromHex(address),\n        (v) => v.asHex(),\n        getAccountId(address),\n      ),\n    getDeployer: (code) =>\n      getDeployer(provider, encodingProvider, Enum(\"Upload\", code), (v) =>\n        v.asHex(),\n      ),\n    readDeploymentEvents(events) {\n      // Contract.Instantiated event not available yet in pallet-revive\n      // but we can find events if the contract emits something on deploy\n\n      const contractEmittedEvents =\n        events?.filter(\n          (evt) =>\n            evt.type === \"Revive\" &&\n            (evt.value as any).type === \"ContractEmitted\",\n        ) ?? []\n      const contractAddresses = Array.from(\n        new Set<string>(\n          contractEmittedEvents\n            .map((evt) => (evt as any).value.value?.contract?.asHex?.())\n            .filter((v) => !!v),\n        ),\n      )\n\n      return contractAddresses.map((address) => ({\n        address,\n        contractEvents: encodingProvider.filterEvents(\n          address,\n          contractEmittedEvents,\n        ),\n      }))\n    },\n    addressIsMapped: (address) =>\n      typedApi.query.Revive.OriginalAccount.getValue(\n        ss58ToEthereum(address),\n        atBest ? { at: \"best\" } : {},\n      ).then((r) => r != null),\n  }\n}\n\nexport const getAccountId = (address: HexString) => {\n  const publicKey = mergeUint8([\n    Binary.fromHex(address).asBytes(),\n    new Uint8Array(new Array(32 - 20).fill(0xee)),\n  ])\n\n  return AccountId().dec(publicKey)\n}\n"],"names":[],"mappings":";;;;;;;;;AAiBO,MAAM,eAAA,GAAkB,CAI7B,QAAA,EACA,mBAAA,EACA,OAAA,KACmD;AACnD,EAAA,MAAM,EAAE,MAAA,EAAO,GAAI,EAAE,GAAG,cAAA,EAAgB,GAAG,OAAA,EAAQ;AACnD,EAAA,MAAM,QAAA,GAAW,cAAA,CAAe,QAAA,EAAU,MAAM,CAAA;AAChD,EAAA,MAAM,mBAAmB,mBAAA,CAAoB,QAAA,GACzC,YAAY,mBAAmB,CAAA,GAC/B,YAAY,mBAAmB,CAAA;AAEnC,EAAA,OAAO;AAAA,IACL,WAAA,EAAa,CAAC,OAAA,KACZ,WAAA;AAAA,MACE,QAAA;AAAA,MACA,gBAAA;AAAA,MACA,MAAA,CAAO,QAAQ,OAAO,CAAA;AAAA,MACtB,CAAC,CAAA,KAAM,CAAA,CAAE,KAAA,EAAM;AAAA,MACf,aAAa,OAAO;AAAA,KACtB;AAAA,IACF,WAAA,EAAa,CAAC,IAAA,KACZ,WAAA;AAAA,MAAY,QAAA;AAAA,MAAU,gBAAA;AAAA,MAAkB,IAAA,CAAK,UAAU,IAAI,CAAA;AAAA,MAAG,CAAC,CAAA,KAC7D,CAAA,CAAE,KAAA;AAAM,KACV;AAAA,IACF,qBAAqB,MAAA,EAAQ;AAI3B,MAAA,MAAM,wBACJ,MAAA,EAAQ,MAAA;AAAA,QACN,CAAC,GAAA,KACC,GAAA,CAAI,SAAS,QAAA,IACZ,GAAA,CAAI,MAAc,IAAA,KAAS;AAAA,WAC3B,EAAC;AACR,MAAA,MAAM,oBAAoB,KAAA,CAAM,IAAA;AAAA,QAC9B,IAAI,GAAA;AAAA,UACF,sBACG,GAAA,CAAI,CAAC,GAAA,KAAS,GAAA,CAAY,MAAM,KAAA,EAAO,QAAA,EAAU,KAAA,IAAS,EAC1D,MAAA,CAAO,CAAC,CAAA,KAAM,CAAC,CAAC,CAAC;AAAA;AACtB,OACF;AAEA,MAAA,OAAO,iBAAA,CAAkB,GAAA,CAAI,CAAC,OAAA,MAAa;AAAA,QACzC,OAAA;AAAA,QACA,gBAAgB,gBAAA,CAAiB,YAAA;AAAA,UAC/B,OAAA;AAAA,UACA;AAAA;AACF,OACF,CAAE,CAAA;AAAA,IACJ,CAAA;AAAA,IACA,iBAAiB,CAAC,OAAA,KAChB,QAAA,CAAS,KAAA,CAAM,OAAO,eAAA,CAAgB,QAAA;AAAA,MACpC,eAAe,OAAO,CAAA;AAAA,MACtB,MAAA,GAAS,EAAE,EAAA,EAAI,MAAA,KAAW;AAAC,KAC7B,CAAE,IAAA,CAAK,CAAC,CAAA,KAAM,KAAK,IAAI;AAAA,GAC3B;AACF;AAEO,MAAM,YAAA,GAAe,CAAC,OAAA,KAAuB;AAClD,EAAA,MAAM,YAAY,UAAA,CAAW;AAAA,IAC3B,MAAA,CAAO,OAAA,CAAQ,OAAO,CAAA,CAAE,OAAA,EAAQ;AAAA,IAChC,IAAI,WAAW,IAAI,KAAA,CAAM,KAAK,EAAE,CAAA,CAAE,IAAA,CAAK,GAAI,CAAC;AAAA,GAC7C,CAAA;AAED,EAAA,OAAO,SAAA,EAAU,CAAE,GAAA,CAAI,SAAS,CAAA;AAClC;;;;"}