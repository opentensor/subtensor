{"version":3,"file":"get-contract.mjs","sources":["../../../src/get-contract.ts"],"sourcesContent":["import {\n  flattenResult,\n  mapResult,\n  wrapAsyncTx,\n} from \"@polkadot-api/common-sdk-utils\"\nimport { Enum, SS58String } from \"polkadot-api\"\nimport type {\n  GenericInkDescriptors,\n  InkSdkTypedApi,\n  ReviveSdkTypedApi,\n} from \"./descriptor-types\"\nimport { EncodingProvider } from \"./encoding-provider\"\nimport { getDeployer } from \"./get-deployer\"\nimport { getStorage } from \"./get-storage\"\nimport { ContractsProvider } from \"./provider\"\nimport type { Contract } from \"./sdk-types\"\nimport { getSignedStorage, getStorageLimit } from \"./util\"\n\nexport function getContract<\n  T extends InkSdkTypedApi | ReviveSdkTypedApi,\n  Addr,\n  StorageErr,\n  D extends GenericInkDescriptors,\n  PublicAddr extends string,\n>(\n  provider: ContractsProvider<Addr, StorageErr>,\n  encodingProvider: EncodingProvider,\n  address: Addr,\n  mapAddr: (v: Addr) => PublicAddr,\n  accountId: SS58String,\n): Contract<T, D, PublicAddr, StorageErr> {\n  const codeHash = provider.getCodeHash(address).then((r) => {\n    if (!r) {\n      throw new Error(`Contract ${mapAddr(address)} not found`)\n    }\n    return r\n  })\n\n  const deployer = getDeployer<T, Addr, StorageErr, D, PublicAddr>(\n    provider,\n    encodingProvider,\n    Enum(\"Existing\", codeHash),\n    mapAddr,\n  )\n\n  const contractApi: Contract<T, D, PublicAddr, StorageErr> = {\n    accountId,\n    getBalance: () => provider.getBalance(address),\n    async isCompatible() {\n      try {\n        const code_hash = await codeHash\n        return code_hash ? encodingProvider.isCompatible(code_hash) : false\n      } catch (ex) {\n        console.error(ex)\n        return false\n      }\n    },\n    getStorage: () => getStorage(provider, encodingProvider, address),\n    async query(message, args) {\n      const msg = encodingProvider.message(message)\n\n      const data = msg.encode(args.data ?? {})\n      const value = args.value ?? 0n\n      const response = await provider.dryRunCall(\n        args.origin,\n        address,\n        value,\n        args.options?.gasLimit,\n        args.options?.storageDepositLimit,\n        data,\n      )\n      if (response.result.success) {\n        const availableData = {\n          events: encodingProvider.filterEvents(\n            mapAddr(address),\n            response.events,\n          ),\n          gasRequired: response.gas_required,\n          storageDeposit: getSignedStorage(response.storage_deposit),\n          send: () => {\n            const limitParams = {\n              gasLimit: response.gas_required,\n              storageDepositLimit: getStorageLimit(response.storage_deposit),\n            }\n            return contractApi.send(message, {\n              ...args,\n              ...limitParams,\n            })\n          },\n        }\n\n        // In case REVERT flag is set, it might return a string with the error message or debug info.\n        if (response.result.value.flags & 0x01) {\n          const data = response.result.value.data\n          return {\n            success: false,\n            value: {\n              type: \"FlagReverted\",\n              value: {\n                ...availableData,\n                message: encodingProvider.decodeError(data),\n                raw: response.result.value.data,\n              },\n            },\n          }\n        }\n\n        const decoded = msg.decode(\n          response.result.value.data,\n        ) as D[\"__types\"][\"messages\"][typeof message][\"response\"]\n        return mapResult(flattenResult(decoded), {\n          value: (innerResponse) => ({\n            response: innerResponse,\n            ...availableData,\n          }),\n        })\n      }\n      return {\n        success: false,\n        value: response.result.value,\n      }\n    },\n    send: (message, args) =>\n      wrapAsyncTx(async () => {\n        const data = encodingProvider.message(message).encode(args.data ?? {})\n\n        const limits = await (async () => {\n          if (\"gasLimit\" in args)\n            return {\n              gas: args.gasLimit,\n              storage: args.storageDepositLimit,\n            }\n\n          const response = await provider.dryRunCall(\n            args.origin,\n            address,\n            args.value ?? 0n,\n            undefined,\n            undefined,\n            data,\n          )\n\n          return {\n            gas: response.gas_required,\n            storage: getStorageLimit(response.storage_deposit),\n          }\n        })()\n\n        return provider.txCall({\n          dest: address,\n          value: args.value ?? 0n,\n          gas_limit: limits.gas,\n          storage_deposit_limit: limits.storage,\n          data,\n        })\n      }),\n    dryRunRedeploy: deployer.dryRun,\n    redeploy: deployer.deploy,\n    filterEvents(events) {\n      return encodingProvider.filterEvents(mapAddr(address), events)\n    },\n  }\n\n  return contractApi\n}\n"],"names":["data"],"mappings":"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"}